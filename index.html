<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monza 2026 朝聖助手 - 結算專家版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8f9fa; -webkit-tap-highlight-color: transparent; }
        .ferrari-red { background-color: #FF0000; }
        .text-ferrari { color: #FF0000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .btn-press:active { transform: scale(0.95); }
        .active-eur { background-color: #1a1a1a; }
        .active-twd { background-color: #FF0000; }
        .itinerary-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #FF0000; }
        .glass-btn { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .v-enter-active, .v-leave-active { transition: all 0.3s ease; }
        .v-enter-from, .v-leave-to { opacity: 0; transform: translateY(-10px); }
        input[type="checkbox"]:checked { background-color: #FF0000; border-color: #FF0000; }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col shadow-xl overflow-hidden relative">
        
        <!-- Header 工具列 -->
        <header class="ferrari-red text-white p-6 pb-12 rounded-b-[40px] shadow-lg relative z-30">
            <div class="flex justify-between items-center">
                <div class="flex-1 mr-2 overflow-hidden">
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase leading-none truncate">{{ appTitle }}</h1>
                    <p class="text-[10px] opacity-80 font-bold tracking-widest uppercase mt-1 truncate">{{ appSubTitle }}</p>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <button @click="activeTab = 'docs'" class="btn-press w-10 h-10 rounded-full glass-btn flex items-center justify-center shadow-sm"><i class="fas fa-flag-checkered text-lg"></i></button>
                    <button @click="toggleCurrency" :class="showCurrency ? 'bg-white text-ferrari' : 'glass-btn'" class="btn-press h-10 px-3 rounded-full flex items-center gap-2 transition-all shadow-sm"><i class="fas fa-coins text-sm"></i><span class="text-xs font-black italic">€1={{ exchangeRate }}</span></button>
                    <button @click="toggleTranslate" :class="showTranslate ? 'bg-white text-ferrari' : 'glass-btn'" class="btn-press w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-sm"><i class="fas fa-language text-xl"></i></button>
                </div>
            </div>

            <!-- 工具面板 (匯率/翻譯) -->
            <transition><div v-if="showCurrency" class="absolute left-6 right-6 top-full mt-2 bg-white rounded-3xl p-5 shadow-2xl text-gray-800 border border-gray-100 z-50">
                <div class="flex justify-between items-center mb-3 px-1"><span class="text-xs font-black text-ferrari italic uppercase">即時換算</span><i @click="showCurrency = false" class="fas fa-times text-gray-300"></i></div>
                <div class="flex items-center gap-4 bg-gray-100 p-4 rounded-2xl">
                    <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold mb-1 uppercase">Euro</label><input v-model="eurInput" type="number" class="w-full bg-transparent border-none p-0 font-black text-2xl focus:ring-0"></div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                    <div class="flex-1 text-right"><label class="text-[10px] text-gray-400 font-bold mb-1 uppercase">TWD</label><div class="font-black text-2xl text-ferrari">≈ {{ (eurInput * exchangeRate).toFixed(0) }}</div></div>
                </div>
            </div></transition>
            <transition><div v-if="showTranslate" class="absolute left-6 right-6 top-full mt-2 bg-white rounded-3xl p-5 shadow-2xl text-gray-800 border border-gray-100 z-50">
                <div class="flex justify-between items-center mb-3 px-1"><span class="text-xs font-black text-ferrari italic uppercase">中意翻譯助理</span><i @click="showTranslate = false" class="fas fa-times text-gray-300"></i></div>
                <div class="relative"><input v-model="transInput" @keyup.enter="translateText" type="text" placeholder="輸入中文..." class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 text-sm focus:ring-2 focus:ring-red-500 font-medium"><button @click="translateText" class="absolute right-2 top-2 bg-red-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-md"><i v-if="!isTranslating" class="fas fa-paper-plane text-xs"></i><i v-else class="fas fa-spinner animate-spin text-xs"></i></button></div>
                <div v-if="transResult" class="bg-red-50 p-5 rounded-2xl border border-red-100 mt-3 animate-pulse-once"><p class="text-gray-800 font-bold leading-tight">{{ transResult }}</p></div>
            </div></transition>
        </header>

        <!-- 主要內容 -->
        <main class="flex-1 overflow-y-auto px-4 -mt-8 no-scrollbar pb-32 z-10">
            
            <!-- 分頁：錢包 (結算專家版) -->
            <div v-if="activeTab === 'wallet'" class="pt-8 px-1">
                <!-- 總結卡片 -->
                <div class="bg-gray-900 rounded-[35px] p-8 text-white mb-6 shadow-2xl relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest italic mb-1">個人預計支付總額 ({{ walletCurrency }})</p>
                            <div @click="walletCurrency = walletCurrency === 'EUR' ? 'TWD' : 'EUR'" class="flex items-center cursor-pointer">
                                <span class="text-[10px] font-black mr-2 italic" :class="walletCurrency === 'EUR' ? 'text-white' : 'text-gray-500'">EUR</span>
                                <div class="w-10 h-5 rounded-full flex items-center p-1" :class="walletCurrency === 'EUR' ? 'active-eur' : 'active-twd'">
                                    <div class="bg-white w-3 h-3 rounded-full shadow-md transform transition-transform" :class="walletCurrency === 'TWD' ? 'translate-x-5' : ''"></div>
                                </div>
                                <span class="text-[10px] font-black ml-2 italic" :class="walletCurrency === 'TWD' ? 'text-white' : 'text-gray-500'">TWD</span>
                            </div>
                        </div>
                        <h2 class="text-4xl font-black italic tracking-tighter mt-2">
                            {{ walletCurrency === 'EUR' ? '€' : 'NT$' }} {{ displayTotalExpenses }}
                        </h2>
                        <div class="mt-6 pt-4 border-t border-white/10">
                            <p class="text-[10px] text-gray-500 font-bold uppercase mb-2">每位成員應負擔總額：</p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                                <div v-for="(val, name) in balances" :key="name" class="flex justify-between text-[11px] font-medium border-b border-white/5 pb-1">
                                    <span class="text-gray-400 italic">{{ name }}</span>
                                    <span class="text-ferrari font-black">{{ walletCurrency === 'EUR' ? '€' : 'NT$' }} {{ (walletCurrency === 'EUR' ? val : val * exchangeRate).toFixed(0) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 明細標題 -->
                <div class="flex justify-between items-center mb-6 px-1">
                    <h2 class="font-black text-xl italic tracking-tight uppercase">消費清單</h2>
                    <button @click="openExpenseModal()" class="text-[10px] font-black bg-white border border-gray-100 text-ferrari px-4 py-2 rounded-full shadow-sm">+ 新增支出</button>
                </div>

                <!-- 帳目明細 -->
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="exp.id" @click="openExpenseModal(idx)" class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex justify-between items-center active:scale-95 transition-transform cursor-pointer">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-2xl bg-red-50 flex items-center justify-center text-ferrari shadow-inner">
                                <i class="fas fa-shopping-basket text-sm"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm tracking-tight">{{ exp.desc }}</h4>
                                <p class="text-[10px] text-gray-400 font-bold uppercase italic tracking-wider">
                                    {{ exp.payer }} 支付 · {{ exp.participants.length }} 人分擔
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <span class="block font-black text-gray-800 italic tracking-tighter">
                                    {{ walletCurrency === 'EUR' ? '€ ' + exp.amount : 'NT$ ' + (exp.amount * exchangeRate).toFixed(0) }}
                                </span>
                                <span class="block text-[9px] font-bold text-gray-300 italic">
                                    一人份: {{ walletCurrency === 'EUR' ? '€ ' + (exp.amount/exp.participants.length).toFixed(1) : 'NT$ ' + (exp.amount/exp.participants.length * exchangeRate).toFixed(0) }}
                                </span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-200 text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分頁：行程 / 票夾 / 設定 (維持優化後邏輯) -->
            <div v-if="activeTab === 'itinerary'">
                <div class="flex gap-3 overflow-x-auto no-scrollbar py-4 mb-2">
                    <div v-for="date in allDates" :key="date" @click="selectedDate = date" :class="[ 'flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all shadow-md', selectedDate === date ? 'ferrari-red text-white scale-110' : 'bg-white text-gray-500' ]">
                        <span class="text-[10px] uppercase font-bold">{{ formatDate(date, 'MMM') }}</span>
                        <span class="text-xl font-black italic leading-none mt-1">{{ formatDate(date, 'DD') }}</span>
                    </div>
                </div>
                <div v-for="item in currentDayItems" :key="item.id" class="bg-white p-5 rounded-3xl shadow-sm flex gap-4 items-center border border-gray-100 itinerary-card relative overflow-hidden mb-4">
                    <div class="text-center min-w-[55px]"><span class="block font-black text-gray-800 text-xl italic leading-none">{{ item.time }}</span></div>
                    <div class="flex-1 pl-4 border-l border-gray-50"><h3 class="font-bold text-gray-800">{{ item.activity }}</h3><div class="text-[11px] text-gray-400 font-medium italic"><i class="fas fa-map-marker-alt text-ferrari mr-1.5"></i>{{ item.location }}</div></div>
                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.location)" target="_blank" class="w-11 h-11 rounded-2xl bg-gray-50 text-blue-500 flex items-center justify-center shadow-inner"><i class="fas fa-location-arrow text-lg"></i></a>
                </div>
            </div>

            <div v-if="activeTab === 'docs'" class="pt-8 px-1">
                <h2 class="font-black text-2xl italic tracking-tight mb-6 uppercase tracking-tighter"><i class="fas fa-flag-checkered text-ferrari mr-2"></i>My Tickets</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(file, idx) in files" :key="idx" class="relative">
                        <div class="bg-white p-2 rounded-3xl shadow-md border border-gray-100 aspect-[3/4] overflow-hidden"><img v-if="file.type.includes('image')" :src="file.url" class="w-full h-full object-cover rounded-2xl"><div v-else class="w-full h-full flex flex-col items-center justify-center bg-gray-50 rounded-2xl"><i class="fas fa-file-pdf text-4xl text-red-500 mb-2"></i><p class="text-[9px] text-gray-400 text-center px-3 font-black uppercase break-all italic">{{ file.name }}</p></div></div>
                        <button @click="removeFile(idx)" class="absolute -top-2 -right-2 bg-black text-white w-7 h-7 rounded-full text-xs flex items-center justify-center shadow-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <button @click="triggerFileUpload" class="border-2 border-dashed border-gray-200 rounded-[30px] flex flex-col items-center justify-center aspect-[3/4] text-gray-300 bg-white/50 hover:border-red-200 transition-colors shadow-sm"><i class="fas fa-plus-circle text-3xl mb-2"></i><span class="text-[10px] font-black uppercase italic tracking-widest text-center px-2">Upload</span></button>
                    <input type="file" id="fileInput" class="hidden" @change="handleFileUpload" accept="image/*,application/pdf">
                </div>
            </div>

            <div v-if="activeTab === 'settings'" class="pt-8 px-1">
                <h2 class="font-black text-2xl italic mb-6 uppercase tracking-tight">旅程管理</h2>
                <div class="space-y-6 bg-white rounded-[30px] p-6 shadow-sm border border-gray-100">
                    <div class="space-y-4">
                        <h3 class="text-xs font-black text-ferrari uppercase tracking-widest italic border-b pb-2">自定義標題</h3>
                        <div><label class="block text-[10px] font-black text-gray-400 mb-2 uppercase italic ml-1 tracking-widest">旅程名稱</label><input v-model="appTitle" @input="saveData" type="text" class="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 font-black text-gray-800 focus:ring-2 focus:ring-red-500"></div>
                        <div><label class="block text-[10px] font-black text-gray-400 mb-2 uppercase italic ml-1 tracking-widest">副標題</label><input v-model="appSubTitle" @input="saveData" type="text" class="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 font-bold text-gray-600 focus:ring-2 focus:ring-red-500"></div>
                    </div>
                    <div class="space-y-4 pt-4">
                        <h3 class="text-xs font-black text-ferrari uppercase tracking-widest italic border-b pb-2">成員設定 (自由人數)</h3>
                        <div><label class="block text-[10px] font-black text-gray-400 mb-2 uppercase italic ml-1 tracking-widest">成員姓名 (用逗號隔開)</label><input v-model="membersInput" @input="updateMembers" type="text" class="w-full bg-gray-50 border-none rounded-2xl px-5 py-4 font-bold text-gray-800 focus:ring-2 focus:ring-red-500" placeholder="例如: 我, 朋友A, 朋友B"></div>
                    </div>
                    <div class="space-y-4 pt-4">
                        <h3 class="text-xs font-black text-ferrari uppercase tracking-widest italic border-b pb-2">時間跨度</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[10px] font-black text-gray-400 mb-2 uppercase italic ml-1 tracking-widest">開始日期</label><input v-model="startDate" @change="saveData" type="date" class="w-full bg-gray-50 border-none rounded-2xl px-4 py-4 font-bold text-sm text-gray-800"></div>
                            <div><label class="block text-[10px] font-black text-gray-400 mb-2 uppercase italic ml-1 tracking-widest">結束日期</label><input v-model="endDate" @change="saveData" type="date" class="w-full bg-gray-50 border-none rounded-2xl px-4 py-4 font-bold text-sm text-gray-800"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 底部導航 -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-xl border-t border-gray-100 px-10 py-5 flex justify-between items-center safe-area-bottom z-50">
            <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-ferrari scale-125' : 'text-gray-300'" class="transition-all duration-300"><i class="fas fa-calendar-alt text-xl"></i></button>
            <button @click="activeTab = 'docs'" :class="activeTab === 'docs' ? 'text-ferrari scale-125' : 'text-gray-300'" class="transition-all duration-300"><i class="fas fa-flag-checkered text-xl"></i></button>
            <button @click="activeTab = 'wallet'" :class="activeTab === 'wallet' ? 'text-ferrari scale-125' : 'text-gray-300'" class="transition-all duration-300"><i class="fas fa-wallet text-xl"></i></button>
            <button @click="activeTab = 'settings'" :class="activeTab === 'settings' ? 'text-ferrari scale-125' : 'text-gray-300'" class="transition-all duration-300"><i class="fas fa-cog text-xl"></i></button>
        </nav>

        <!-- 彈窗: 支出編輯 (重點升級) -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center z-[100] p-4">
            <div class="bg-white w-full rounded-[40px] p-8 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto no-scrollbar">
                <div class="flex justify-between items-center mb-6 px-1">
                    <h3 class="text-xl font-black italic uppercase italic tracking-tighter">{{ editingIndex === null ? '新增支出' : '編輯支出' }}</h3>
                    <i @click="showExpenseModal = false" class="fas fa-times text-gray-300 text-xl cursor-pointer"></i>
                </div>
                <div class="space-y-4 pb-6">
                    <div><label class="text-[10px] font-black text-gray-400 mb-1 ml-2 uppercase italic tracking-widest">消費內容</label><input v-model="newExp.desc" type="text" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 font-bold text-gray-800 focus:ring-2 focus:ring-red-500"></div>
                    <div><label class="text-[10px] font-black text-gray-400 mb-1 ml-2 uppercase italic tracking-widest">金額 (EUR €)</label><input v-model="newExp.amount" type="number" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 font-black text-gray-800 focus:ring-2 focus:ring-red-500"></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black text-gray-400 mb-1 ml-2 uppercase italic tracking-widest">誰付的錢？</label>
                            <select v-model="newExp.payer" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 font-bold text-gray-800 appearance-none"><option v-for="m in members" :key="m" :value="m">{{ m }}</option></select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-black text-gray-400 mb-1 ml-2 uppercase italic tracking-widest">誰分這筆？</label>
                            <div class="bg-gray-50 rounded-2xl p-3 max-h-[120px] overflow-y-auto space-y-2 border border-gray-100">
                                <label v-for="m in members" :key="m" class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" :value="m" v-model="newExp.participants" class="rounded text-ferrari focus:ring-red-500">
                                    <span class="text-xs font-bold text-gray-600">{{ m }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button v-if="editingIndex !== null" @click="removeExpense(editingIndex)" class="flex-1 bg-gray-100 text-gray-400 py-5 rounded-[25px] font-black uppercase italic active:scale-95 transition-all">刪除項目</button>
                        <button @click="saveExpense" class="flex-[2] ferrari-red text-white py-5 rounded-[25px] font-black uppercase italic shadow-lg shadow-red-100 active:scale-95 transition-all">儲存紀錄</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 彈窗: 新增行程 -->
        <div v-if="showAddModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center z-[100] p-4">
            <div class="bg-white w-full rounded-[40px] p-8 shadow-2xl animate-slide-up">
                <div class="flex justify-between items-center mb-6 px-1"><h3 class="text-xl font-black italic uppercase italic tracking-tighter">新增行程點</h3><i @click="showAddModal = false" class="fas fa-times text-gray-300 text-xl cursor-pointer"></i></div>
                <div class="space-y-4 pb-6">
                    <input v-model="newItem.time" type="time" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 font-black text-gray-800">
                    <input v-model="newItem.activity" type="text" placeholder="活動內容" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 font-bold">
                    <input v-model="newItem.location" type="text" placeholder="地點名稱" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 font-bold">
                    <button @click="addItem" class="w-full ferrari-red text-white py-5 rounded-[25px] font-black uppercase italic shadow-lg mt-4 active:scale-95 transition-all">儲存項目</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // 從 LocalStorage 載入
                const savedConfig = JSON.parse(localStorage.getItem('monza_v6_config')) || {};
                const appTitle = ref(savedConfig.appTitle || 'MONZA 2026');
                const appSubTitle = ref(savedConfig.appSubTitle || '平安出門 平安回來');
                const startDate = ref(savedConfig.startDate || '2026-09-02');
                const endDate = ref(savedConfig.endDate || '2026-09-07');
                const members = ref(savedConfig.members || ['我', '夥伴']);
                const membersInput = ref(members.value.join(', '));

                // 核心狀態
                const activeTab = ref('itinerary');
                const selectedDate = ref(startDate.value);
                const walletCurrency = ref('EUR');
                const exchangeRate = ref(35.2);
                const showCurrency = ref(false);
                const showTranslate = ref(false);
                const eurInput = ref(1);

                // 翻譯助理
                const transInput = ref('');
                const transResult = ref('');
                const isTranslating = ref(false);

                // 支出邏輯 (重點升級)
                const expenses = ref(JSON.parse(localStorage.getItem('monza_v6_expenses')) || []);
                const showExpenseModal = ref(false);
                const editingIndex = ref(null);
                const newExp = ref({ id: null, desc: '', amount: null, payer: members.value[0], participants: [...members.value] });

                const balances = computed(() => {
                    let map = {};
                    members.value.forEach(m => map[m] = 0);
                    expenses.value.forEach(exp => {
                        const perPerson = parseFloat(exp.amount || 0) / Math.max(1, exp.participants.length);
                        exp.participants.forEach(p => {
                            if (map.hasOwnProperty(p)) map[p] += perPerson;
                        });
                    });
                    return map;
                });

                const displayTotalExpenses = computed(() => {
                    const totalEur = expenses.value.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
                    return walletCurrency.value === 'EUR' ? totalEur.toFixed(1) : (totalEur * exchangeRate.value).toFixed(0);
                });

                const openExpenseModal = (idx = null) => {
                    if (idx !== null) {
                        editingIndex.value = idx;
                        const target = expenses.value[idx];
                        newExp.value = { ...target, participants: [...target.participants] };
                    } else {
                        editingIndex.value = null;
                        newExp.value = { id: Date.now(), desc: '', amount: null, payer: members.value[0], participants: [...members.value] };
                    }
                    showExpenseModal.value = true;
                };

                const saveExpense = () => {
                    if (!newExp.value.desc || !newExp.value.amount || newExp.value.participants.length === 0) {
                        alert("請填寫內容、金額並至少勾選一位分擔者");
                        return;
                    }
                    if (editingIndex.value !== null) {
                        expenses.value[editingIndex.value] = { ...newExp.value };
                    } else {
                        expenses.value.push({ ...newExp.value });
                    }
                    showExpenseModal.value = false;
                    saveData();
                };

                const removeExpense = (idx) => {
                    if (confirm("確定要刪除這筆支出嗎？")) {
                        expenses.value.splice(idx, 1);
                        showExpenseModal.value = false;
                        saveData();
                    }
                };

                // 行程與檔案 (穩定邏輯)
                const itinerary = ref(JSON.parse(localStorage.getItem('monza_v6_itinerary')) || []);
                const files = ref(JSON.parse(localStorage.getItem('monza_v6_files')) || []);
                const showAddModal = ref(false);
                const newItem = ref({ time: '', activity: '', location: '' });

                const triggerFileUpload = () => document.getElementById('fileInput').click();
                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => { files.value.push({ name: file.name, type: file.type, url: event.target.result }); saveData(); };
                    reader.readAsDataURL(file);
                };
                const removeFile = (idx) => { files.value.splice(idx, 1); saveData(); };

                const updateMembers = () => {
                    members.value = membersInput.value.split(/[,，]/).map(m => m.trim()).filter(m => m !== '');
                    saveData();
                };

                const translateText = async () => {
                    if (!transInput.value) return;
                    isTranslating.value = true;
                    try {
                        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transInput.value)}&langpair=zh-TW|it`);
                        const data = await res.json();
                        transResult.value = data.responseData.translatedText;
                    } catch (e) { transResult.value = "翻譯異常"; }
                    finally { isTranslating.value = false; }
                };

                const fetchRate = async () => {
                    try {
                        const res = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                        const data = await res.json();
                        exchangeRate.value = data.rates.TWD.toFixed(1);
                    } catch (e) { console.warn('匯率更新失敗'); }
                };

                const addItem = () => {
                    if (newItem.value.time && newItem.value.activity) {
                        itinerary.value.push({ id: Date.now(), date: selectedDate.value, ...newItem.value });
                        newItem.value = { time: '', activity: '', location: '' }; showAddModal.value = false; saveData();
                    }
                };

                const allDates = computed(() => {
                    const dates = [];
                    let curr = new Date(startDate.value);
                    while (curr <= new Date(endDate.value)) {
                        dates.push(curr.toISOString().split('T')[0]);
                        curr.setDate(curr.getDate() + 1);
                    }
                    return dates;
                });
                const currentDayItems = computed(() => {
                    return itinerary.value.filter(i => i.date === selectedDate.value).sort((a, b) => a.time.localeCompare(b.time));
                });
                const formatDate = (d, type) => {
                    const date = new Date(d);
                    return type === 'MMM' ? date.toLocaleString('zh-TW', { month: 'short' }) : date.getDate();
                };

                const saveData = () => {
                    localStorage.setItem('monza_v6_config', JSON.stringify({
                        appTitle: appTitle.value, appSubTitle: appSubTitle.value,
                        startDate: startDate.value, endDate: endDate.value, members: members.value
                    }));
                    localStorage.setItem('monza_v6_itinerary', JSON.stringify(itinerary.value));
                    localStorage.setItem('monza_v6_files', JSON.stringify(files.value));
                    localStorage.setItem('monza_v6_expenses', JSON.stringify(expenses.value));
                };

                onMounted(() => fetchRate());

                return {
                    activeTab, appTitle, appSubTitle, selectedDate, allDates, currentDayItems, formatDate, startDate, endDate,
                    showCurrency, showTranslate, toggleCurrency, toggleTranslate, exchangeRate, eurInput, 
                    transInput, transResult, translateText, isTranslating,
                    walletCurrency, expenses, displayTotalExpenses, balances, showExpenseModal, newExp, editingIndex, openExpenseModal, saveExpense, removeExpense,
                    members, membersInput, updateMembers,
                    files, triggerFileUpload, handleFileUpload, removeFile,
                    showAddModal, newItem, addItem, saveData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
